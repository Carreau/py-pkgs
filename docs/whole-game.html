<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 The Whole Game | Python packages</title>
  <meta name="description" content="A simple and practical introduction to creating and distributing Python code via Python packages" />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 The Whole Game | Python packages" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="A simple and practical introduction to creating and distributing Python code via Python packages" />
  <meta name="github-repo" content="ttimbers/py-pkgs" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 The Whole Game | Python packages" />
  
  <meta name="twitter:description" content="A simple and practical introduction to creating and distributing Python code via Python packages" />
  

<meta name="author" content="Tiffany Timbers &amp; Tomas Beuzen" />


<meta name="date" content="2020-02-25" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="setup.html"/>
<link rel="next" href="package-structure.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Python packages</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>1</b> System setup</a><ul>
<li class="chapter" data-level="1.1" data-path="setup.html"><a href="setup.html#python-setup"><i class="fa fa-check"></i><b>1.1</b> Installing and updating Python</a></li>
<li class="chapter" data-level="1.2" data-path="setup.html"><a href="setup.html#register-for-a-pypi-account"><i class="fa fa-check"></i><b>1.2</b> Register for a PyPI account</a></li>
<li class="chapter" data-level="1.3" data-path="setup.html"><a href="setup.html#python-ides"><i class="fa fa-check"></i><b>1.3</b> Python IDEs</a><ul>
<li class="chapter" data-level="1.3.1" data-path="setup.html"><a href="setup.html#pycharm"><i class="fa fa-check"></i><b>1.3.1</b> PyCharm</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="setup.html"><a href="setup.html#rstudio-python-setup"><i class="fa fa-check"></i><b>1.4</b> Setting up the RStudio IDE with Python</a><ul>
<li class="chapter" data-level="1.4.1" data-path="setup.html"><a href="setup.html#find-where-anaconda-is-installed-on-your-machine"><i class="fa fa-check"></i><b>1.4.1</b> Find where Anaconda is installed on your machine</a></li>
<li class="chapter" data-level="1.4.2" data-path="setup.html"><a href="setup.html#configuring-reticulate-for-to-use-the-python-repl-inside-rstudio"><i class="fa fa-check"></i><b>1.4.2</b> Configuring <code>reticulate</code> for to use the Python REPL inside RStudio</a></li>
<li class="chapter" data-level="1.4.3" data-path="setup.html"><a href="setup.html#configuring-the-rstudio-terminal"><i class="fa fa-check"></i><b>1.4.3</b> Configuring the RStudio terminal</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="whole-game.html"><a href="whole-game.html"><i class="fa fa-check"></i><b>2</b> The Whole Game</a><ul>
<li class="chapter" data-level="2.1" data-path="whole-game.html"><a href="whole-game.html#poetry-to-create-project"><i class="fa fa-check"></i><b>2.1</b> Use Cookiecutter &amp; Poetry to create a Python project</a></li>
<li class="chapter" data-level="2.2" data-path="whole-game.html"><a href="whole-game.html#version-control"><i class="fa fa-check"></i><b>2.2</b> Put your project under version control</a><ul>
<li class="chapter" data-level="2.2.1" data-path="whole-game.html"><a href="whole-game.html#set-up-local-version-control"><i class="fa fa-check"></i><b>2.2.1</b> Set-up local version control</a></li>
<li class="chapter" data-level="2.2.2" data-path="whole-game.html"><a href="whole-game.html#set-up-remote-version-control"><i class="fa fa-check"></i><b>2.2.2</b> Set-up remote version control</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="whole-game.html"><a href="whole-game.html#first-function"><i class="fa fa-check"></i><b>2.3</b> Writing our first function</a></li>
<li class="chapter" data-level="2.4" data-path="whole-game.html"><a href="whole-game.html#test-drive-your-package-code"><i class="fa fa-check"></i><b>2.4</b> Test drive your package code</a></li>
<li class="chapter" data-level="2.5" data-path="whole-game.html"><a href="whole-game.html#pkg-func-deps"><i class="fa fa-check"></i><b>2.5</b> Add package function dependencies</a></li>
<li class="chapter" data-level="2.6" data-path="whole-game.html"><a href="whole-game.html#pkg-docs"><i class="fa fa-check"></i><b>2.6</b> Package documentation</a><ul>
<li class="chapter" data-level="2.6.1" data-path="whole-game.html"><a href="whole-game.html#local-docs"><i class="fa fa-check"></i><b>2.6.1</b> Reading and rendering the docs locally</a></li>
<li class="chapter" data-level="2.6.2" data-path="whole-game.html"><a href="whole-game.html#remote-docs"><i class="fa fa-check"></i><b>2.6.2</b> Reading and rendering the docs remotely</a></li>
</ul></li>
<li class="chapter" data-level="2.7" data-path="whole-game.html"><a href="whole-game.html#testing"><i class="fa fa-check"></i><b>2.7</b> Testing</a></li>
<li class="chapter" data-level="2.8" data-path="whole-game.html"><a href="whole-game.html#build-and-publish"><i class="fa fa-check"></i><b>2.8</b> Building your package and publishing to testPyPI</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="package-structure.html"><a href="package-structure.html"><i class="fa fa-check"></i><b>3</b> Package structure and state</a><ul>
<li class="chapter" data-level="3.1" data-path="package-structure.html"><a href="package-structure.html#package-states"><i class="fa fa-check"></i><b>3.1</b> Package states</a></li>
<li class="chapter" data-level="3.2" data-path="package-structure.html"><a href="package-structure.html#python-modules"><i class="fa fa-check"></i><b>3.2</b> Modules</a></li>
<li class="chapter" data-level="3.3" data-path="package-structure.html"><a href="package-structure.html#python-packages"><i class="fa fa-check"></i><b>3.3</b> Python packages</a></li>
<li class="chapter" data-level="3.4" data-path="package-structure.html"><a href="package-structure.html#source-distributions"><i class="fa fa-check"></i><b>3.4</b> Source distribution packages</a></li>
<li class="chapter" data-level="3.5" data-path="package-structure.html"><a href="package-structure.html#binary-distributions"><i class="fa fa-check"></i><b>3.5</b> Binary distribution packages</a></li>
<li class="chapter" data-level="3.6" data-path="package-structure.html"><a href="package-structure.html#python-poetry"><i class="fa fa-check"></i><b>3.6</b> Poetry and pyproject.toml</a></li>
<li class="chapter" data-level="3.7" data-path="package-structure.html"><a href="package-structure.html#installed-packages"><i class="fa fa-check"></i><b>3.7</b> Installed packages</a></li>
<li class="chapter" data-level="3.8" data-path="package-structure.html"><a href="package-structure.html#imported-packages"><i class="fa fa-check"></i><b>3.8</b> Imported Packages</a></li>
<li class="chapter" data-level="3.9" data-path="package-structure.html"><a href="package-structure.html#python-applications"><i class="fa fa-check"></i><b>3.9</b> Packaging Python Applications</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Python packages</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="whole-game" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> The Whole Game</h1>
<p>This chapter demonstrates how to develop an entire small toy Python package from beginning to end. It’s purpose is to give a high level overview of how a Python package can and should be developed. Later chapters will explore packaging in Python in more detail. This chapter is a Pythonified version of <a href="https://r-pkgs.org/whole-game.html">the Whole Game chapter</a> written by Jenny Bryan that can be found in the the <a href="https://r-pkgs.org/">R packages book</a>.</p>
<div id="poetry-to-create-project" class="section level2">
<h2><span class="header-section-number">2.1</span> Use Cookiecutter &amp; Poetry to create a Python project</h2>
<p>So that we do not have to create a file and directory structure for our project from scratch, we will use Cookiecutter &amp; Poetry to do this for us (which you installed back in <a href="setup.html#python-setup">1.1 Installing and updating Python</a>. First, we use Cookiecutter to create the file and directory structure for our Python project (which will be a Python package). We will use a simplified version of the template base by the <a href="https://www.pyopensci.org/">PyOpenSci</a> organization designed specifically for creating Python packages. PyOpenSci is a not-for-profit organization that promotes open and reproducible research through peer-review of scientific Python packages.</p>
<p>To use Cookiecutter to set up the structure of your Python package, run the line of code below in the terminal from the directory where you would like your package to live.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" data-line-number="1">$ cookiecutter https:<span class="op">//</span>github.com<span class="op">/</span>UBC<span class="op">-</span>MDS<span class="op">/</span>cookiecutter<span class="op">-</span>ubc<span class="op">-</span>mds.git</a></code></pre></div>
<p>You will be prompted to provide information that will help customize the project.</p>
<blockquote>
<p>In this tutorial we will be calling our package <code>foocat</code>. However, we will eventually be publishing our package to <a href="https://test.pypi.org/">testPyPI</a> which is a testing version of Python’s main package index <a href="https://pypi.org/">PyPI</a>. Package names on testPyPI and PyPI must be unique. As a result, you will need to choose a <strong>unique name for your package</strong> while following this tutorial. Something like <code>foocat_[your intials]</code> might be appropriate, but you can always check if your chosen name is already taken by visitng testPyPI and searching that name.</p>
</blockquote>
<p>Below is an example of how to respond to the Cookiecutter prompts (default values for each attribute are shown in square brackets, hitting enter will accept the default attribute value):</p>
<pre><code>full_name [Audrey Roy Greenfeld]: Tiffany Timbers
email [audreyr@example.com]: tiffany.timbers@gmail.com
github_username [audreyr]: ttimbers
project_name [Python Boilerplate]: foocat
project_slug [foocat]: foocat
project_short_description [Python Boilerplate contains all the boilerplate you need to create a Python package.]: Python package that eases the pain concatenating Pandas categoricals!
pypi_username [ttimbers]: 
version [&#39;0.1.0&#39;]: 
Select open_source_license:
1 - MIT license
2 - BSD license
3 - ISC license
4 - Apache Software License 2.0
5 - GNU General Public License v3
Choose from 1, 2, 3, 4, 5 [1]: 1</code></pre>
<p>You will now have a new directory called <code>foocat</code>. Navigate into the <code>foocat</code> directory and initialize the project as a Poetry project so that we can take advantage of the package management and building tools of Poetry:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" data-line-number="1">$ cd foocat</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">$ poetry init</a></code></pre></div>
<p>Again we are prompted for more information. Once again, default values are shown in square brackets and have been populated where possible from our Cookiecutter template. Here is an example of how to respond the the prompts:</p>
<pre><code>This command will guide you through creating your pyproject.toml config.

Package name [foocat]:  
Version [0.1.0]:  
Description []:  Python package that eases the pain concatenating Pandas categoricals!
Author [ttimbers &lt;tiffany.timbers@stat.ubc.ca&gt;, n to skip]:  
License []:  MIT
Compatible Python versions [^3.7]:  

Would you like to define your main dependencies interactively? (yes/no) [yes] no
Would you like to define your dev dependencies (require-dev) interactively (yes/no) [yes] no
Generated file

[tool.poetry]
name = &quot;foocat&quot;
version = &quot;0.1.0&quot;
description = &quot;Python package that eases the pain concatenating Pandas categoricals!&quot;
authors = [&quot;ttimbers &lt;tiffany.timbers@stat.ubc.ca&gt;&quot;]
license = &quot;MIT&quot;

[tool.poetry.dependencies]
python = &quot;^3.7&quot;

[tool.poetry.dev-dependencies]

[build-system]
requires = [&quot;poetry&gt;=0.12&quot;]
build-backend = &quot;poetry.masonry.api&quot;


Do you confirm generation? (yes/no) [yes]</code></pre>
<p><em>Note - we said no to defining our dependencies interactively because it is more efficient to define them using <code>poetry add</code> which we will explore a bit later on.</em></p>
<p>After using Cookiecutter and Poetry, we end up with the following directory structure:</p>
<pre><code>foocat
├── CONDUCT.md
├── CONTRIBUTING.md
├── CONTRIBUTORS.md
├── docs
│   └── conf.py
│   └── contributing.rst
│   └── contributors.rst
│   └── index.rst
│   └── installation.rst
│   └── Makefile
│   └── readme.rst
│   └── usage.rst
├── foocat
│   └── __init__.py
│   └── foocat.py
├── .github
│   └── workflows
│       └── build.yml
│       └── release.yml
├── .gitignore
├── LICENSE
├── pyproject.toml
└── tests
    ├── __init__.py
    └── test_foocat.py</code></pre>
<p>These two simple steps (Cookiecutter + Poetry) have given us a boilerplate file and directory structure suitable for building our Python package. While there are quite a few files in our boilerplate, at this point we only need to worry about a few of these files and directories to get a working package together. Specifically, we’ll be working on:</p>
<ul>
<li>the file for us to write out Python functions that our package will distribute (<code>foocat/foocat.py</code>);</li>
<li>the home for our tests to ensure that our package functions work as we expect they should (<code>tests/test_foocat.py</code>); and,</li>
<li>the <code>pyproject.toml</code> file that defines our project’s metadata and dependencies and how it will eventually be built and distributed.</li>
</ul>
<p>Later chapters will focus on the oter components of the boilerplate, which can be used to refine your package and packaging process with, for example, quality documentation, continuous integration testing, version bumping, etc.</p>
<blockquote>
<p><strong>Optional for RStudio IDE users</strong></p>
<p>Users of the RStudio IDE may also want to make this Python project directory an RStudio project. Why might you ask? Well, once you have an <code>*.Rproj</code> file, you can use that file to quickly open the RStudio IDE (which has a terminal and an interactive Python REPL, assuming you have set this up with <code>reticulate</code>) to the project’s root directory.</p>
</blockquote>
</div>
<div id="version-control" class="section level2">
<h2><span class="header-section-number">2.2</span> Put your project under version control</h2>
<p>It is good practice to put your data science projects under local and remote version control. The tools we recommend using for this are Git &amp; GitHub. For this book, we assume readers have <a href="https://git-scm.com/">Git</a> installed on their machine, have novice Git skills, and that have a <a href="https://github.com/">GitHub.com</a> account.</p>
<div id="set-up-local-version-control" class="section level3">
<h3><span class="header-section-number">2.2.1</span> Set-up local version control</h3>
<p>From the terminal and in the root <code>foocat</code> directory, we will initialize the repository to be tracked by Git using:</p>
<pre><code>$ git init</code></pre>
<pre><code>Initialized empty Git repository in /Users/tiffany/Documents/ubc-mds/foocat/.git/</code></pre>
<p>Next, we need to tell Git which files to track (which will be all of them at this point) and commit these changes locally:</p>
<pre><code>$ git add .
$ git commit -m &quot;initial project set-up&quot;</code></pre>
<pre><code>[master (root-commit) ca03932] initial project set-up
 22 files changed, 798 insertions(+)
 create mode 100644 .github/workflows/build.yml
 create mode 100644 .github/workflows/release.yml
 create mode 100644 .gitignore
 create mode 100644 CONDUCT.md
 create mode 100755 CONTRIBUTING.md
 create mode 100755 CONTRIBUTORS.md
 create mode 100755 LICENSE
 create mode 100644 README.md
 create mode 100755 docs/Makefile
 create mode 100755 docs/conf.py
 create mode 100755 docs/contributing.rst
 create mode 100755 docs/contributors.rst
 create mode 100755 docs/index.rst
 create mode 100755 docs/installation.rst
 create mode 100755 docs/make.bat
 create mode 100755 docs/readme.rst
 create mode 100755 docs/usage.rst
 create mode 100644 foocat/__init__.py
 create mode 100644 foocat/foocat.py
 create mode 100644 pyproject.toml
 create mode 100644 tests/__init__.py
 create mode 100644 tests/test_foocat.py</code></pre>
</div>
<div id="set-up-remote-version-control" class="section level3">
<h3><span class="header-section-number">2.2.2</span> Set-up remote version control</h3>
<p>Now that we have set up our local version control, let’s create a repository on <a href="https://github.com/">GitHub.com</a> and set that as the remote version control home for this project:</p>
<p><img src="img/set-up-github1.png"></p>
<p>The options we recommend for setting up a repository for a Python package using the workflow we present in this book include:</p>
<ul>
<li>give the GitHub.com repository the same name as your Python Poetry project’s name</li>
<li>make the GitHub.com repository public</li>
<li><strong>do not</strong> initialize the GitHub.com repository with a README</li>
</ul>
<p><img src="img/set-up-github2.png" ></p>
<p>Next, we set-up the remote address locally, and push our project to GitHub.com:</p>
<pre><code>$ git remote add origin git@github.com:ttimbers/foocat.git
$ git push -u origin master</code></pre>
<blockquote>
<p>Note: the example above uses SSH authentication with GitHub, HTTPS authentication works as well and would use this url in place of the one shown above to set the remote: <code>https://github.com/ttimbers/foocat.git</code>.</p>
</blockquote>
</div>
</div>
<div id="first-function" class="section level2">
<h2><span class="header-section-number">2.3</span> Writing our first function</h2>
<p>Pandas categoricals are a very useful data type for modeling (and were inspired by R’s factors), but certain manipulations of this data type can be tricky during data wrangling. One such challenge is concatenation (joining) of Pandas categoricals. Let’s observe the result of trying to concatenate two Pandas categoricals objects:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> a <span class="op">=</span> pd.Categorical([<span class="st">&quot;character&quot;</span>, <span class="st">&quot;hits&quot;</span>, <span class="st">&quot;your&quot;</span>, <span class="st">&quot;eyeballs&quot;</span>])</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> b <span class="op">=</span> pd.Categorical([<span class="st">&quot;but&quot;</span>, <span class="st">&quot;integer&quot;</span>, <span class="st">&quot;where it&quot;</span>, <span class="st">&quot;counts&quot;</span>])</a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="op">&gt;&gt;&gt;</span> pd.concat([a, b])</a></code></pre></div>
<pre><code>## Error in py_call_impl(callable, dots$args, dots$keywords): TypeError: cannot concatenate object of type &#39;&lt;class &#39;pandas.core.arrays.categorical.Categorical&#39;&gt;&#39;; only Series and DataFrame objs are valid</code></pre>
<p>This occurs because the categoricals are represented as integers in memory, and in <code>a</code> the integer 0 corresponds to the word “character” while in <code>b</code>, the integer 0 corresponds to the word “but”. Thus, when we ask Python to concatenate these two Pandas categorical options it doesn’t know what to do with these integer mappings to different categories, and so it throws an error. We can get around this several ways, one way is to convert the Pandas categoricals to a <code>str</code> type, then do the concatenation, and finally convert the concatenated Pandas obeject to a categorical again. We demonstrate that approach below:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> concatenated <span class="op">=</span> pd.concat([pd.Series(a.astype(<span class="st">&quot;str&quot;</span>)), pd.Series(b.astype(<span class="st">&quot;str&quot;</span>))])</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> pd.Categorical(concatenated)</a></code></pre></div>
<pre><code>## [character, hits, your, eyeballs, but, integer, where it, counts]
## Categories (8, object): [but, character, counts, eyeballs, hits, integer, where it, your]</code></pre>
<p>That seems to work 🎉, but it’s quite a bit of typing every time we want to do this… So let’s turn this code into a function called <code>catbind</code>!</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">def</span> catbind(a, b):</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  concatenated <span class="op">=</span> pd.concat([pd.Series(a.astype(<span class="st">&quot;str&quot;</span>)),</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">                 pd.Series(b.astype(<span class="st">&quot;str&quot;</span>))])</a>
<a class="sourceLine" id="cb20-4" data-line-number="4">  <span class="cf">return</span> pd.Categorical(concatenated)</a>
<a class="sourceLine" id="cb20-5" data-line-number="5"></a>
<a class="sourceLine" id="cb20-6" data-line-number="6">catbind(a, b)</a></code></pre></div>
<pre><code>## [character, hits, your, eyeballs, but, integer, where it, counts]
## Categories (8, object): [but, character, counts, eyeballs, hits, integer, where it, your]</code></pre>
<blockquote>
<p>Note - this book assumes you know how to write, document and test functions in Python. To learn more about this see <a href="http://greenteapress.com/thinkpython/html/thinkpython004.html">Think Python, Chapter 3: Functions</a> by Allen Downey.</p>
</blockquote>
<p>Where do we save this function if we want it to be a part of our <code>foocat</code> Python package? Let’s review the landscape of our Python project so far:</p>
<pre><code>foocat
├── CONDUCT.md
├── CONTRIBUTING.md
├── CONTRIBUTORS.md
├── docs
│   └── conf.py
│   └── contributing.rst
│   └── contributors.rst
│   └── index.rst
│   └── installation.rst
│   └── Makefile
│   └── readme.rst
│   └── usage.rst
├── foocat
│   └── __init__.py
│   └── foocat.py
├── .github
│   └── workflows
│       └── build.yml
│       └── release.yml
├── .gitignore
├── LICENSE
├── pyproject.toml
└── tests
    ├── __init__.py
    └── test_foocat.py</code></pre>
<p>All the code that we would like the user to run as part of our package should live inside the <code>foocat</code> directory. Typically, with a relatively small package with just a few functions, we would house them inside a single python module (i.e., a <code>.py</code> file). Our template project directory structure already created and named such a module for us: <code>foocat/foocat.py</code>. Let’s save our function there. Additionally, given that our package depends on the Pandas Python package, we should import Pandas at the top of the <code>foocat.py</code> file. Here’s what <code>foocat.py</code> should now look like:</p>
<pre><code>import pandas as pd


def catbind(a, b):
    concatenated = pd.concat([pd.Series(a.astype(&quot;str&quot;)),
                              pd.Series(b.astype(&quot;str&quot;))])
    return pd.Categorical(concatenated)
</code></pre>
</div>
<div id="test-drive-your-package-code" class="section level2">
<h2><span class="header-section-number">2.4</span> Test drive your package code</h2>
<p>To test drive the function we just wrote we first install the package locally using Python poetry. We choose to do this with Python Poetry as opposed to using Python’s native package manager <code>pip</code> because Poetry automatically creates a virtual environment for us and will perform tricky tasks like package solving that can sometimes trip us up when we use <code>pip</code> alone.</p>
<pre><code>$ poetry install</code></pre>
<pre><code>Creating virtualenv foocat-z0_J6H1I-py3.7 in /Users/tiffany/Library/Caches/pypoetry/virtualenvs

Installing dependencies from lock file

No dependencies to install or update

  - Installing foocat (0.1.0)</code></pre>
<p>Now, inside this project directory, we can open an interactive Python session (using <code>python</code> at the CL) and import our <code>foocat</code> module which contains our <code>catbind</code> function as shown:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">from</span> foocat <span class="im">import</span> foocat</a></code></pre></div>
<p>The <code>foocat</code> module has now been mapped to the current session’s namespace and we can access the <code>catbind</code> function in our Python session using dot notation: <code>foocat.catbind</code> (note that if you wanted to import a specific function, rather than the whole module, you could do <code>from foocat.foocat import catbind</code>, in which case “dot notation” would not be required to use the function). Let’s try to use the function to concatenate two Pandas categoricals:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="op">&gt;&gt;&gt;</span> <span class="im">import</span> pandas <span class="im">as</span> pd</a>
<a class="sourceLine" id="cb27-2" data-line-number="2"><span class="op">&gt;&gt;&gt;</span> a <span class="op">=</span> pd.Categorical([<span class="st">&quot;character&quot;</span>, <span class="st">&quot;hits&quot;</span>, <span class="st">&quot;your&quot;</span>, <span class="st">&quot;eyeballs&quot;</span>])</a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="op">&gt;&gt;&gt;</span> b <span class="op">=</span> pd.Categorical([<span class="st">&quot;but&quot;</span>, <span class="st">&quot;integer&quot;</span>, <span class="st">&quot;where it&quot;</span>, <span class="st">&quot;counts&quot;</span>])</a>
<a class="sourceLine" id="cb27-4" data-line-number="4"><span class="op">&gt;&gt;&gt;</span> foocat.catbind(a, b)</a></code></pre></div>
<pre><code>[character, hits, your, eyeballs, but, integer, where it, counts]
Categories (8, object): [but, character, counts, eyeballs, hits, integer, where it, your]</code></pre>
<p>Hurray again! This seems to work as expected! Now that we have something working, let’s commit this to version control:</p>
<pre><code>$ git add .
$ git commit -m &quot;First working version of catbind function&quot;</code></pre>
<pre><code>[master b80dea8] First working version of catbind function
 1 file changed, 7 insertions(+)</code></pre>
</div>
<div id="pkg-func-deps" class="section level2">
<h2><span class="header-section-number">2.5</span> Add package function dependencies</h2>
<p>Our function depends on the Pandas package, and without it, it would fail to work. Thus we need to record this dependency in a useful place so that when we publish our pacakged code this important information (and the mechanism for making it work) will be shipped along with it. We again use <code>poetry</code> to do this, using the <code>add</code> command. This command will update the <code>[tool.poetry.dependencies]</code> section of the <code>pyproject.toml</code> file which currently looks like this and lists only Python as a project dependency:</p>
<pre><code>[tool.poetry]
name = &quot;foocat&quot;
version = &quot;0.1.0&quot;
description = &quot;Python package that eases the pain concatenating Pandas categoricals!&quot;
authors = [&quot;ttimbers &lt;tiffany.timbers@stat.ubc.ca&gt;&quot;]
license = &quot;MIT&quot;

[tool.poetry.dependencies]
python = &quot;^3.7&quot;

[tool.poetry.dev-dependencies]

[build-system]
requires = [&quot;poetry&gt;=0.12&quot;]
build-backend = &quot;poetry.masonry.api&quot;</code></pre>
<p>Let’s add our Pandas dependency now:</p>
<pre><code>$ poetry add pandas</code></pre>
<pre><code>Using version ^1.0.1 for pandas

Updating dependencies
Resolving dependencies... (0.1s)

Writing lock file


Package operations: 4 installs, 1 update, 0 removals

  - Updating six (1.14.0 /usr/local/Cellar/poetry/1.0.3/libexec/vendor/lib/python3.7/site-packages -&gt; 1.14.0)
  - Installing numpy (1.18.1)
  - Installing python-dateutil (2.8.1)
  - Installing pytz (2019.3)
  - Installing pandas (1.0.1)</code></pre>
<p>Now if we view our <code>pyproject.toml</code> file we see that <code>pandas</code> is now listed as a dependency:</p>
<pre><code>[tool.poetry]
name = &quot;foocat&quot;
version = &quot;0.1.0&quot;
description = &quot;Python package that eases the pain concatenating Pandas categoricals!&quot;
authors = [&quot;ttimbers &lt;tiffany.timbers@stat.ubc.ca&gt;&quot;]
license = &quot;MIT&quot;

[tool.poetry.dependencies]
python = &quot;^3.7&quot;
pandas = &quot;^1.0.1&quot;

[tool.poetry.dev-dependencies]

[build-system]
requires = [&quot;poetry&gt;=0.12&quot;]
build-backend = &quot;poetry.masonry.api&quot;</code></pre>
<p>This changed two files, <code>pyrpoject.toml</code> (which we printed above) and <code>poetry.lock</code> (a record of all the packages and exact versions of them that poetry downloaded for this project). These changes are important for our package, so let’s commit them to version control as well:</p>
<pre><code>$ git add .
$ git commit -m &quot;added pandas as a dependency&quot;</code></pre>
<pre><code>[master f5c146d] added pandas as a dependency
 2 files changed, 108 insertions(+)
 create mode 100644 poetry.lock</code></pre>
<blockquote>
<p>For those of you who have used <code>requirements.txt</code> before with <code>pip</code>, you can think of <code>poetry.lock</code> as the <code>poetry</code> equivalent of that file. You can even generate a <code>requirements.txt</code> from poetry via <code>poetry export -f requirements.txt &gt; requirements.txt</code> if needed.</p>
</blockquote>
</div>
<div id="pkg-docs" class="section level2">
<h2><span class="header-section-number">2.6</span> Package documentation</h2>
<div id="local-docs" class="section level3">
<h3><span class="header-section-number">2.6.1</span> Reading and rendering the docs locally</h3>
<p>For the users of your code (include your future self!) we need to have readable and accessible documentation expressing how to install your package, and how to use the user-facing functions within it. The Python packaging ecosystem has a tool to help you make this process more efficient - <a href="https://docs.readthedocs.io/en/stable/intro/getting-started-with-sphinx.html">Sphinx</a>. In the Cookiecutter template we provided you to set-up this package, there is a basic docs template that the Cookiecutter progam filled in with the information you entered interactively when you ran <code>cookiecutter https://github.com/UBC-MDS/cookiecutter-ubc-mds.git</code>. These files live in the <code>doc</code> directory and are <code>.rst</code> (reStructuredText markup language) filetype. This is a lightweight markup language that works similar to Markdown but uses different syntax. The templates provided to you here are fairly well formatted already, so you do not have to change the <code>.rst</code> formatting, however if you are interested in doing so, you can see this <a href="https://thomas-cokelaer.info/tutorials/sphinx/rest_syntax.html">CheatsSheet</a> to get started.</p>
<p>First, we need to install <code>sphinx</code> as a development dependency using <code>poetry</code>.</p>
<pre><code>$ poetry add --dev sphinx</code></pre>
<blockquote>
<p>Note the use of <code>--dev</code> to specify a development, rather than a package function dependency. If you look in <code>pyproject.toml</code> you will see that <code>sphinx</code> gets added under the <code>[tool.poetry.dev-dependencies]</code> section as opposed to the <code>[tool.poetry.dependencies]</code> section (where package function dependencies get installed, such as pandas in this example).</p>
</blockquote>
<p>Next, to render the help documents locally from <code>.rst</code> to <code>.html</code> we navigate into the <code>docs</code> directory and then run the <code>Makefile</code> there, directing it to run the <code>.html</code> target:</p>
<pre><code>$ cd docs
$ poetry run make html</code></pre>
<blockquote>
<p>Note 1: we append <code>poetry run</code> infront of most of our commands in this Python package workflow so that we ensure we are using the software tools installed in the <code>poetry</code> virtual environment.</p>
</blockquote>
<blockquote>
<p>Note 2: you may see many red warnings, these can be ignored and are meerely suggestions on how to improve your docs if you wish.</p>
</blockquote>
<p>If we now look inside our <code>docs</code> directory we see that it has expanded, and the rendered <code>.html</code> files live in <code>_build/html</code>. We can open <code>_build/html/index.html</code> to view our docs locally on our laptop, they should look something like this:</p>
<p><img src="img/sphinx-docs1.png" width=600></p>
<p>If we click on the “Module Index” link under the heading “Indices and tables” we get a “Your file was not found message”:</p>
<p><img src="img/sphinx-docs2.png" width=600></p>
<p>This is because we haven’t written any documentation for our package function. Let’s do that now by adding a <code>numpy</code>-style docstring to the <code>catbind</code> function in <code>foocat/foocat.py</code> as shown below:</p>
<pre><code>import pandas as pd


def catbind(a, b):
    &quot;&quot;&quot;
    Concatenates two pandas categoricals.

    Parameters
    ----------
    a : pandas.core.arrays.categorical.Categorical
      A pandas categorical.
    b : pandas.core.arrays.categorical.Categorical
      A pandas categorical that you wish to concatenate to a.

    Returns
    -------
    pandas.core.arrays.categorical.Categorical
      The new concatenated pandas categorical.

    Examples
    --------
    &gt;&gt;&gt; from foocat import foocat
    &gt;&gt;&gt; a = pd.Categorical([&quot;character&quot;, &quot;hits&quot;, &quot;your&quot;, &quot;eyeballs&quot;])
    &gt;&gt;&gt; b = pd.Categorical([&quot;but&quot;, &quot;integer&quot;, &quot;where it&quot;, &quot;counts&quot;])
    &gt;&gt;&gt; foocat.catbind(a, b)
    [character, hits, your, eyeballs, but, integer, where it, counts]
    Categories (8, object): [but, character, counts,
    eyeballs, hits, integer, where it, your]
    &quot;&quot;&quot;
    concatenated = pd.concat([pd.Series(a.astype(&quot;str&quot;)),
                   pd.Series(b.astype(&quot;str&quot;))])
    return pd.Categorical(concatenated)</code></pre>
<p>Now we can use a <code>sphinx</code> extension (<code>napolean</code>) in combination with <code>autodoc</code> to render our <code>numpy</code>-styled docstring into a modules page on our docs. To do this we need to install another dev dependency:</p>
<pre><code>$ poetry add --dev sphinxcontrib-napoleon</code></pre>
<blockquote>
<p>Note - to use this, we also have to add <code>extensions = ['sphinx.ext.napoleon']</code> in the <code>conf.py</code> file in the <code>docs</code> directory, but we have taken care of this for you with our Cookiecutter template.</p>
</blockquote>
<p>Then we can change back to our root <code>foocat</code> directory, use <code>sphinx-apidoc</code> and <code>poetry</code> to re-render our docs:</p>
<pre><code>$ cd ..
$ poetry run sphinx-apidoc -f -o docs/source foocat
$ cd docs
$ poetry run make html</code></pre>
<p>Now when we click on the “Module Index” link under the heading “Indices and tables” we see a webpage that has a link to our module, <code>foocat.foocat</code>:</p>
<p><img src="img/sphinx-docs3.png" width=600></p>
<p>And we can click on that to see the docs for <code>foocat.foocat.catbind</code>. Which should look roughly like this:</p>
<p><img src="img/sphinx-docs4.png" width=600></p>
<p>Another hurray! 🎉🎉🎉 Let’s commit this to version control and push to our remote:</p>
<pre><code>$ cd ..
$ git add .
$ git commit -m &quot;generated and render docs for local viewing&quot;
$ git push</code></pre>
<pre><code>[master ae68b4e] generated and render docs for local viewing
 5 files changed, 471 insertions(+), 8 deletions(-)
 rewrite foocat/foocat.py (77%)
 create mode 100644 docs/source/foocat.rst
 create mode 100644 docs/source/modules.rst</code></pre>
</div>
<div id="remote-docs" class="section level3">
<h3><span class="header-section-number">2.6.2</span> Reading and rendering the docs remotely</h3>
<p>To share these docs online, we need to link our GitHub repository to <a href="https://readthedocs.org/">Read the Docs</a> (where we will build and host our docs remotely). To do this:</p>
<ol style="list-style-type: decimal">
<li>Visit <a href="https://readthedocs.org/" class="uri">https://readthedocs.org/</a> and click on “Sign up”;</li>
<li>Select “Sign up with GitHub”;</li>
<li>Click “Import a Project”;</li>
<li>Click “Import Manually”;</li>
<li>Fill in the project details by providing a package name (this must be a unique name, we’ve already taken “foocat” so perhaps try “foocat[your initials]”), the repository URL, and leave the rest as is. Click “Next”;</li>
<li>Click “Build version”.</li>
</ol>
<p>After following the steps above, your docs should get successfully built on <a href="https://readthedocs.org/">Read the Docs</a> and you should be able to access them via the “View Docs” button on the build page, or from the link that Cookiecutter created for your on your repositories <code>README.md</code> file.</p>
<blockquote>
<p>Note: for <a href="https://readthedocs.org/">Read the Docs</a> to work with the <code>poetry</code> package workflow you need to have a <code>.readthedocs.yml</code> in the root of your Python package. We have created this for you using Cookiecutter and you can view it <a href="https://github.com/UBC-MDS/cookiecutter-ubc-mds/blob/master/%7B%7Bcookiecutter.project_slug%7D%7D/.readthedocs.yml">here</a>.</p>
</blockquote>
</div>
</div>
<div id="testing" class="section level2">
<h2><span class="header-section-number">2.7</span> Testing</h2>
<p>We have interactively taken <code>catbind</code> for a test drive, but to prove to our future self and others that our code does in fact do what it is supposed to do, let’s write some formal unit tests. In Python packages, our tests live inside the <code>test</code> directory, typically in a file called <code>test_&lt;module_name&gt;.py</code>, thus for this package this is <code>tests/test_foocat.py</code>. Let’s add a unit test (as a function named <code>test_catbind</code>) for our <code>catbind</code> function there now:</p>
<pre><code>from foocat import foocat
import pandas as pd


def test_catbind():
    a = pd.Categorical([&quot;character&quot;, &quot;hits&quot;, &quot;your&quot;, &quot;eyeballs&quot;])
    b = pd.Categorical([&quot;but&quot;, &quot;integer&quot;, &quot;where it&quot;, &quot;counts&quot;])
    assert ((foocat.catbind(a, b)).codes == [1, 4, 7, 3, 0, 5, 6, 2]).all()
    assert ((foocat.catbind(a, b)).categories == [&quot;but&quot;, &quot;character&quot;,
            &quot;counts&quot;, &quot;eyeballs&quot;, &quot;hits&quot;, &quot;integer&quot;, &quot;where it&quot;, &quot;your&quot;]).all()
</code></pre>
<blockquote>
<p>Note - given that we use <code>pd.Categorical</code> to create objects to test on, we have to import the <code>pandas</code> package in our test file.</p>
</blockquote>
<p>We only have a single function to test for this package, and so we could run this file by opening up an interactive Python session, importing the file, and then calling the <code>test_catbind</code> function. But as our packages have more and more functions, and more and more modules (or submodules) then we want to automate this workflow. In the Python package ecosystem one way we can do this is to use <code>pytest</code>. A single call to <code>pytest</code> from the root of a project will look for all files in the <code>tests</code> directory, import all files prefixed with <code>test*</code> and then call all functions prefixed with <code>test*</code>. Pretty nice eh?</p>
<p>To do this, we first add <code>pytest</code> as a dev dependency via <code>poetry</code>:</p>
<pre><code>$ poetry add --dev pytest</code></pre>
<p>Then to run the tests, we use <code>poetry</code> to run <code>pytest</code> in our virtual environment:</p>
<pre><code>$ poetry run pytest</code></pre>
<p>We get no error returned to us, indicating that our tests passed, Hurray! This suggests that the code we wrote is correct (at least to our test specifications)! Now we can share this with the world by putting these under local and remote version control:</p>
<pre><code>$ git add .
$ git commit -m &quot;added unit tests for catbind&quot;
$ git push</code></pre>
<blockquote>
<p>Note: It is very possible that your tests are correct and your function passes the tests yet the build button on the GitHub repository README still says “build: failing”. This is because the build continuous integration has more checks than just whether the tests pass, for example, it also checks code style using a tool called <code>flake8</code>. This and the other build checks are the subject of later chapters in this book.</p>
</blockquote>
</div>
<div id="build-and-publish" class="section level2">
<h2><span class="header-section-number">2.8</span> Building your package and publishing to testPyPI</h2>
<p>Python packages are generally shared via the <a href="https://pypi.org/">PyPI package index</a>. However, when we are just starting to develop packages, and/or at the development stage of our package, we typically first check that everything works by submitting to <a href="https://test.pypi.org/">testPyPi</a>. <code>poetry</code> has a command called <code>publish</code> which we can use to do this, however it’s default is to publish to PyPI. We can add this to the list of repositories <code>poetry</code> knows about via <code>poetry config repositories.&lt;your_project&gt; https://test.pypi.org/legacy/</code> as shown below:</p>
<pre><code>$ poetry config repositories.foocat https://test.pypi.org/legacy/</code></pre>
<p>Before we send our package, we first need to build it to source and wheel distributions (the format that PyPI distributes and something you’ll learn more about in the next chapter <a href="package-structure.html#package-structure">Package structure and state</a>) using <code>poetry build</code>:</p>
<pre><code>$ poetry build</code></pre>
<p>And, finally, now to publish to testPyPI we can use <code>poetry publish</code> (you will be prompted for your testPyPI username and password, sign up for one if you have not already done so):</p>
<pre><code>$ poetry publish -r test-pypi</code></pre>
<p>Now you should be able to visit your package on testPyPI (e.g., <a href="https://test.pypi.org/project/foocat/" class="uri">https://test.pypi.org/project/foocat/</a>) and download it from there using <code>pip</code> via:</p>
<pre><code>pip install -i https://test.pypi.org/simple/ foocat</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="setup.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="package-structure.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/ttimbers/py-pkgs/edit/master/02-the-whole-game.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
